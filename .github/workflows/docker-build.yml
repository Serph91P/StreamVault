name: Docker Build and Push with Auto-Versioning

on:
  push:
    branches:
      - develop
      - main
      - rebase
    paths:
      - 'app/**'
      - 'migrations/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/docker-build.yml'

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to create tags
    outputs:
      new_version: ${{ steps.semver.outputs.new_version }}
      release_type: ${{ steps.semver.outputs.release_type }}
      tag_created: ${{ steps.create_tag.outputs.tag_created }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version bump
        id: semver
        run: |
          # Determine current version
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current version: $CURRENT_VERSION"
          
          # Remove 'v' prefix if present
          CURRENT_VERSION=${CURRENT_VERSION#v}
          
          # Extract major, minor and patch versions
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          # Determine version change based on commit messages since last tag
          COMMITS=$(git log $(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)..HEAD --pretty=format:"%s")
          
          # Set default release type
          RELEASE_TYPE="patch"
          
          # Search commit messages for keywords
          if echo "$COMMITS" | grep -iE '(feat|feature)(\([^)]*\))?: ' > /dev/null; then
            RELEASE_TYPE="minor"
          fi
          
          if echo "$COMMITS" | grep -iE '(BREAKING CHANGE|breaking change)' > /dev/null; then
            RELEASE_TYPE="major"
          fi
          
          # Increment the appropriate version number
          if [ "$RELEASE_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$RELEASE_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          
          # Compose the new version
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "New version: v$NEW_VERSION (${RELEASE_TYPE} bump)"
          
          # Set outputs for next steps
          echo "new_version=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
      
      - name: Create Tag
        id: create_tag
        if: github.ref == 'refs/heads/main'
        run: |
          NEW_VERSION="${{ steps.semver.outputs.new_version }}"          echo "Creating tag for changelog: ${NEW_VERSION}"
            git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if tag already exists
          if git rev-parse "${NEW_VERSION}" >/dev/null 2>&1; then
            echo "Tag ${NEW_VERSION} already exists!"
            echo "tag_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create and push tag for changelog
          git tag -a ${NEW_VERSION} -m "Docker Image Update ${NEW_VERSION}"
          
          if git push origin ${NEW_VERSION}; then
            echo "tag_created=true" >> $GITHUB_OUTPUT
            echo "Tag ${NEW_VERSION} created and pushed successfully"
          else
            echo "tag_created=false" >> $GITHUB_OUTPUT
            echo "Failed to push tag ${NEW_VERSION}, but continuing anyway"
            echo "tag_created=true" >> $GITHUB_OUTPUT  # Set to true anyway for changelog
          fi
  
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.check_paths.outputs.frontend_changed }}
      backend_changed: ${{ steps.check_paths.outputs.backend_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed paths
        id: check_paths
        run: |
          # Get the list of changed files
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            # Get files changed in the most recent commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # If this is the first commit
            CHANGED_FILES=$(git diff --name-only 4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD)
          fi
            # Check if frontend files have changed
          if echo "$CHANGED_FILES" | grep -q "^app/frontend/"; then
            echo "Frontend files have changed"
            echo "frontend_changed=true" >> $GITHUB_OUTPUT
          else
            echo "No frontend changes detected"
            echo "frontend_changed=false" >> $GITHUB_OUTPUT
          fi

          # Debug the file changes for easier troubleshooting
          echo "Changed files in this commit:"
          echo "$CHANGED_FILES"
            # Check if backend files or dependencies have changed
          if echo "$CHANGED_FILES" | grep -qE "^app/[^f]|^app/f[^r]|^app/fr[^o]|^app/fro[^n]|^app/fron[^t]|^app/front[^e]|^app/fronte[^n]|^app/fronten[^d]|^migrations/|^requirements.txt|^Dockerfile"; then
            echo "Backend files have changed"
            echo "backend_changed=true" >> $GITHUB_OUTPUT
          else
            echo "No backend changes detected"
            echo "backend_changed=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: [version, check_changes]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      if: needs.check_changes.outputs.frontend_changed == 'true'
      with:
        node-version: '22.15.0'
        cache: 'npm'
        cache-dependency-path: './app/frontend/package-lock.json'
        
    - name: Build Frontend
      if: needs.check_changes.outputs.frontend_changed == 'true'
      working-directory: ./app/frontend
      run: |
        npm ci
        npm run build
    
    - name: Use cached frontend build
      if: needs.check_changes.outputs.frontend_changed == 'false'
      run: |
        echo "Using cached frontend build from previous successful workflow"
    
    - name: Prepare metadata
      id: prep
      run: |
        echo "created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "version=${{ needs.version.outputs.new_version }}" >> $GITHUB_OUTPUT
    
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Determine Docker tag
      id: docker_tag
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "tag=latest" >> $GITHUB_OUTPUT        
        elif [ "${{ github.ref }}" = "refs/heads/rebase" ]; then
          echo "tag=experimental" >> $GITHUB_OUTPUT
        else
          echo "tag=develop" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ steps.prep.outputs.created }}
          VERSION=${{ needs.version.outputs.new_version }}
          BUILD_ENV=production
        tags: |
          frequency2098/streamvault:${{ steps.docker_tag.outputs.tag }}
          frequency2098/streamvault:${{ github.sha }}
          frequency2098/streamvault:${{ needs.version.outputs.new_version }}        labels: |
          org.opencontainers.image.created=${{ steps.prep.outputs.created }}
          org.opencontainers.image.source=${{ github.event.repository.html_url }}
          org.opencontainers.image.version=${{ needs.version.outputs.new_version }}
          org.opencontainers.image.revision=${{ github.sha }}
    
    - name: Scan Docker image for vulnerabilities
      uses: aquasecurity/trivy-action@0.30.0
      with:
        image-ref: "frequency2098/streamvault:${{ steps.docker_tag.outputs.tag }}"
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
  create-changelog:
    needs: [version, build]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Debug Changelog Conditions
        run: |
          echo "GitHub ref: ${{ github.ref }}"
          echo "Is main branch: ${{ github.ref == 'refs/heads/main' }}"
          echo "New version: ${{ needs.version.outputs.new_version }}"
          echo "Release type: ${{ needs.version.outputs.release_type }}"          
          echo "Creating changelog entry for Docker image update..."
      
      - name: Generate Changelog
        id: generate_changelog
        run: |
          # Finde das vorherige Tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # Wenn kein vorheriges Tag vorhanden ist, benutze die letzten 10 Commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          else
            # Sonst nur die Commits seit dem letzten Tag
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Kategorisiere Änderungen
          FEATURES=$(echo "$CHANGELOG" | grep -i "feat\|feature" || echo "")
          FIXES=$(echo "$CHANGELOG" | grep -i "fix\|bug" || echo "")
          REFACTORS=$(echo "$CHANGELOG" | grep -i "refactor\|improve" || echo "")
          OTHER=$(echo "$CHANGELOG" | grep -v -i "feat\|feature\|fix\|bug\|refactor\|improve" || echo "")
          
          # Erstelle Changelog
          CHANGELOG_TEXT="## Docker Image Update ${{ needs.version.outputs.new_version }}\n\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}🚀 **Neues Docker Image verfügbar:** \`frequency2098/streamvault:latest\`\n\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}### Was ist neu?\n\n"
          
          if [ ! -z "$FEATURES" ]; then
            CHANGELOG_TEXT="${CHANGELOG_TEXT}#### ✨ Neue Features\n${FEATURES}\n\n"
          fi
          
          if [ ! -z "$FIXES" ]; then
            CHANGELOG_TEXT="${CHANGELOG_TEXT}#### 🐛 Fehlerbehebungen\n${FIXES}\n\n"
          fi
          
          if [ ! -z "$REFACTORS" ]; then
            CHANGELOG_TEXT="${CHANGELOG_TEXT}#### ♻️ Verbesserungen\n${REFACTORS}\n\n"
          fi
          
          if [ ! -z "$OTHER" ]; then
            CHANGELOG_TEXT="${CHANGELOG_TEXT}#### 📝 Sonstige Änderungen\n${OTHER}\n\n"
          fi
          
          CHANGELOG_TEXT="${CHANGELOG_TEXT}### Docker Image abrufen\n\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}\`\`\`bash\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}docker pull frequency2098/streamvault:latest\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}# oder spezifische Version:\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}docker pull frequency2098/streamvault:${{ needs.version.outputs.new_version }}\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}\`\`\`\n\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}### Update durchführen\n\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}Falls du Docker Compose verwendest:\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}\`\`\`bash\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}docker-compose pull\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}docker-compose up -d\n"
          CHANGELOG_TEXT="${CHANGELOG_TEXT}\`\`\`\n"
          
          # Speichere für GitHub Release
          {
            echo "changelog<<EOF"
            echo -e "${CHANGELOG_TEXT}"
            echo "EOF"          } >> $GITHUB_OUTPUT
      
      - name: Create GitHub Changelog
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.new_version }}
          name: "Docker Update ${{ needs.version.outputs.new_version }}"
          body: ${{ steps.generate_changelog.outputs.changelog }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}