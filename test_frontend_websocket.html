<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1f1f23;
            color: white;
        }
        .log {
            background-color: #2a2a2a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: #333;
        }
        .error {
            border-left-color: #dc3545;
        }
        .success {
            border-left-color: #28a745;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>StreamVault WebSocket Test</h1>
    
    <div>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div>
        <h3>Connection Status: <span id="status">Disconnected</span></h3>
        <h3>Message Log:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let ws = null;
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        function addMessage(message, type = 'message') {
            const log = document.getElementById('log');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            log.appendChild(messageDiv);
            log.scrollTop = log.scrollHeight;
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('Already connected', 'error');
                return;
            }
            
            const wsUrl = `ws://${window.location.host}/ws`;
            addMessage(`Connecting to ${wsUrl}...`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateStatus('Connected');
                addMessage('WebSocket connected successfully', 'success');
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addMessage(`Received: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    // Handle specific message types
                    if (data.type === 'queue_stats_update') {
                        addMessage(`Queue Stats: ${JSON.stringify(data.data)}`, 'success');
                    } else if (data.type === 'task_status_update') {
                        addMessage(`Task Status: ${data.data.task_type} - ${data.data.status}`, 'success');
                    } else if (data.type === 'recording_job_update') {
                        addMessage(`Recording: ${data.data.streamer_name} - ${data.data.status}`, 'success');
                    }
                } catch (e) {
                    addMessage(`Raw message: ${event.data}`);
                }
            };
            
            ws.onclose = function() {
                updateStatus('Disconnected');
                addMessage('WebSocket disconnected', 'error');
            };
            
            ws.onerror = function(error) {
                updateStatus('Error');
                addMessage(`WebSocket error: ${error}`, 'error');
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                updateStatus('Disconnected');
                addMessage('WebSocket disconnected by user');
            }
        }
        
        function sendTestMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('Not connected', 'error');
                return;
            }
            
            const testMessage = {
                type: 'test',
                message: 'Hello from frontend test'
            };
            
            ws.send(JSON.stringify(testMessage));
            addMessage(`Sent: ${JSON.stringify(testMessage)}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Auto-connect on page load
        connect();
    </script>
</body>
</html>
