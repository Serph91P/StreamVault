<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StreamVault - PWA Installation Test</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6f42c1">
    <meta name="description" content="Automated Twitch stream recording and management platform">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="StreamVault">
    
    <!-- Apple Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StreamVault">
    <link rel="apple-touch-icon" href="/apple-icon-180x180.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.ico">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .install-status {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .install-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 10px;
        }
        
        .install-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .install-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .debug-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .feature-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        
        .feature-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .feature-card p {
            opacity: 0.9;
            line-height: 1.5;
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffc107;
            margin-top: 15px;
        }
        
        .criteria-list {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .criteria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .criteria-item:last-child {
            border-bottom: none;
        }
        
        .status-icon {
            font-size: 1.2rem;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .features { grid-template-columns: 1fr; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì± StreamVault PWA</h1>
        <p>Teste die Installation als Progressive Web App</p>
    </div>
    
    <div class="main-content">
        <div class="install-status">
            <h2 id="install-title">üöÄ App Installation</h2>
            <p id="install-description">Pr√ºfe PWA-Installationsm√∂glichkeiten...</p>
            <div class="timer" id="engagement-timer">0:00</div>
            <div style="margin-top: 20px;">
                <button id="install-button" class="install-btn" disabled>Installation wird vorbereitet...</button>
                <br>
                <button id="debug-button" class="debug-btn">üîç Debug Info</button>
                <button id="refresh-button" class="debug-btn">üîÑ Aktualisieren</button>
            </div>
        </div>
        
        <div class="criteria-list">
            <h3 style="margin-bottom: 15px;">üìã PWA-Installationskriterien</h3>
            <div id="criteria-https" class="criteria-item">
                <span>HTTPS oder localhost</span>
                <span class="status-icon">‚è≥</span>
            </div>
            <div id="criteria-manifest" class="criteria-item">
                <span>Web App Manifest</span>
                <span class="status-icon">‚è≥</span>
            </div>
            <div id="criteria-sw" class="criteria-item">
                <span>Service Worker</span>
                <span class="status-icon">‚è≥</span>
            </div>
            <div id="criteria-icons" class="criteria-item">
                <span>Icons (144px, 512px)</span>
                <span class="status-icon">‚è≥</span>
            </div>
            <div id="criteria-engagement" class="criteria-item">
                <span>User Engagement (30s+)</span>
                <span class="status-icon">‚è≥</span>
            </div>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <h3>üé• Stream Recording</h3>
                <p>Automatische Aufzeichnung von Twitch-Streams mit intelligenter Archivierung</p>
            </div>
            <div class="feature-card">
                <h3>üì± Mobile Ready</h3>
                <p>Vollst√§ndig responsives Design f√ºr die optimale mobile Nutzung</p>
            </div>
            <div class="feature-card">
                <h3>üîî Push Notifications</h3>
                <p>Benachrichtigungen √ºber neue Streams und wichtige Events</p>
            </div>
            <div class="feature-card">
                <h3>‚ö° Offline Support</h3>
                <p>Grundfunktionen auch ohne Internetverbindung verf√ºgbar</p>
            </div>
        </div>
    </div>

    <script src="/pwa-helper.js"></script>
    <script>
        let installPrompt = null;
        let startTime = Date.now();
        let timerInterval;
        
        // Timer f√ºr User Engagement
        function startEngagementTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('engagement-timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Update engagement criteria
                if (elapsed >= 30) {
                    updateCriteria('criteria-engagement', true);
                }
            }, 1000);
        }
        
        // PWA-Kriterien pr√ºfen
        async function checkCriteria() {
            // HTTPS
            const isSecure = window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname.startsWith('192.168.');
            updateCriteria('criteria-https', isSecure);
            
            // Manifest
            try {
                const manifestResponse = await fetch('/manifest.json');
                const manifest = await manifestResponse.json();
                updateCriteria('criteria-manifest', !!manifest.name);
                
                // Icons
                const hasRequiredIcons = manifest.icons && 
                    manifest.icons.some(icon => icon.sizes.includes('144x144')) &&
                    manifest.icons.some(icon => icon.sizes.includes('512x512'));
                updateCriteria('criteria-icons', hasRequiredIcons);
            } catch (error) {
                updateCriteria('criteria-manifest', false);
                updateCriteria('criteria-icons', false);
            }
            
            // Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    updateCriteria('criteria-sw', registrations.length > 0);
                } catch (error) {
                    updateCriteria('criteria-sw', false);
                }
            } else {
                updateCriteria('criteria-sw', false);
            }
        }
        
        function updateCriteria(id, success) {
            const element = document.getElementById(id);
            const icon = element.querySelector('.status-icon');
            icon.textContent = success ? '‚úÖ' : '‚ùå';
        }
        
        // Install Prompt Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéâ beforeinstallprompt event fired!');
            e.preventDefault();
            installPrompt = e;
            
            const button = document.getElementById('install-button');
            const title = document.getElementById('install-title');
            const description = document.getElementById('install-description');
            
            button.disabled = false;
            button.textContent = 'üì± PWA jetzt installieren';
            title.textContent = 'üéâ Installation verf√ºgbar!';
            description.textContent = 'Die App kann jetzt als PWA installiert werden.';
            
            // Show visual indicator
            button.style.background = '#28a745';
            button.style.animation = 'pulse 2s infinite';
            
            console.log('üí° PWA Install prompt is now ready!');
        });
        
        // Check for install prompt periodically (some browsers delay it)
        let installCheckCount = 0;
        const installChecker = setInterval(() => {
            installCheckCount++;
            console.log(`üîç Install check #${installCheckCount}`);
            
            if (installPrompt) {
                clearInterval(installChecker);
                console.log('‚úÖ Install prompt available after', installCheckCount, 'checks');
            } else if (installCheckCount >= 30) {
                clearInterval(installChecker);
                console.log('‚ùå No install prompt after 30 checks (5 minutes)');
                
                // Show manual install instructions
                const description = document.getElementById('install-description');
                description.innerHTML = `
                    <strong>Keine automatische Installation verf√ºgbar.</strong><br>
                    Manuelle Installation:<br>
                    ‚Ä¢ Chrome: Men√º (‚ãÆ) ‚Üí "Zum Startbildschirm hinzuf√ºgen"<br>
                    ‚Ä¢ Oder Adressleiste ‚Üí Install-Icon (falls vorhanden)
                `;
            }
        }, 10000); // Check every 10 seconds
        
        // Install Button Handler
        document.getElementById('install-button').addEventListener('click', async () => {
            if (window.pwaHelper && window.pwaHelper.canInstall) {
                try {
                    const installed = await window.pwaHelper.install();
                    if (installed) {
                        console.log('‚úÖ PWA installation successful');
                    }
                } catch (error) {
                    console.error('‚ùå PWA installation failed:', error);
                    
                    // Show manual instructions
                    const instructions = window.pwaHelper.getManualInstallInstructions();
                    let instructionText = `Manuelle Installation (${instructions.platform}):\n\n`;
                    instructions.instructions.forEach((step, index) => {
                        instructionText += `${index + 1}. ${step}\n`;
                    });
                    
                    alert(instructionText);
                }
            } else if (!installPrompt) {
                // Fallback for browsers without beforeinstallprompt
                const userAgent = navigator.userAgent;
                let instructions = 'Installation nicht automatisch verf√ºgbar.\n\n';
                
                if (userAgent.includes('Android') && userAgent.includes('Chrome')) {
                    instructions += 'Android Chrome:\n';
                    instructions += '1. Tippen Sie auf Men√º (‚ãÆ)\n';
                    instructions += '2. "Zum Startbildschirm hinzuf√ºgen"\n';
                    instructions += '3. Installation best√§tigen';
                } else if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
                    instructions += 'iOS Safari:\n';
                    instructions += '1. Tippen Sie auf Teilen-Symbol\n';
                    instructions += '2. "Zum Home-Bildschirm"\n';
                    instructions += '3. Namen eingeben und hinzuf√ºgen';
                } else {
                    instructions += 'Desktop Browser:\n';
                    instructions += '1. Schauen Sie nach Install-Icon in Adressleiste\n';
                    instructions += '2. Oder Browser-Men√º verwenden';
                }
                
                alert(instructions);
            } else {
                // Original fallback logic
                try {
                    const result = await installPrompt.prompt();
                    const choice = await result.userChoice;
                    
                    if (choice === 'accepted') {
                        console.log('‚úÖ PWA installation accepted');
                        document.getElementById('install-title').textContent = 'üéâ Installation erfolgreich!';
                        document.getElementById('install-description').textContent = 'Die App wurde erfolgreich installiert.';
                    } else {
                        console.log('‚ùå PWA installation dismissed');
                    }
                    
                    installPrompt = null;
                } catch (error) {
                    console.error('üí• PWA installation failed:', error);
                    alert('Installation fehlgeschlagen: ' + error.message);
                }
            }
        });
        
        // Debug Button
        document.getElementById('debug-button').addEventListener('click', () => {
            console.group('üîç PWA Debug Information');
            console.log('User Agent:', navigator.userAgent);
            console.log('Platform:', navigator.platform);
            console.log('URL:', window.location.href);
            console.log('Protocol:', window.location.protocol);
            console.log('Install Prompt Available:', !!installPrompt);
            console.log('Service Worker Support:', 'serviceWorker' in navigator);
            console.log('Service Worker Controller:', !!navigator.serviceWorker?.controller);
            
            // Check display mode
            const modes = ['standalone', 'minimal-ui', 'fullscreen', 'browser'];
            modes.forEach(mode => {
                console.log(`Display mode ${mode}:`, window.matchMedia(`(display-mode: ${mode})`).matches);
            });
            
            console.groupEnd();
        });
        
        // Refresh Button
        document.getElementById('refresh-button').addEventListener('click', () => {
            window.location.reload();
        });
        
        // App Installation Detection
        window.addEventListener('appinstalled', () => {
            console.log('üéâ PWA was installed successfully!');
            document.getElementById('install-title').textContent = '‚úÖ App installiert!';
            document.getElementById('install-description').textContent = 'StreamVault wurde erfolgreich installiert.';
        });
        
        // Initialize with enhanced PWA helper
        document.addEventListener('DOMContentLoaded', () => {
            startEngagementTimer();
            
            // Use the enhanced PWA helper
            if (window.pwaHelper) {
                // Listen for install events
                window.pwaHelper.on('installable', (canInstall) => {
                    const button = document.getElementById('install-button');
                    const title = document.getElementById('install-title');
                    const description = document.getElementById('install-description');
                    
                    if (canInstall) {
                        button.disabled = false;
                        button.textContent = 'üöÄ PWA installieren';
                        button.style.background = '#28a745';
                        title.textContent = 'üéâ Installation verf√ºgbar!';
                        description.textContent = 'Die App kann jetzt installiert werden.';
                    } else {
                        button.textContent = '‚è≥ Warte auf Installation...';
                        title.textContent = '‚è≥ Installation wird vorbereitet';
                        description.textContent = 'Bitte warten Sie einen Moment...';
                    }
                });
                
                window.pwaHelper.on('installed', () => {
                    const title = document.getElementById('install-title');
                    const description = document.getElementById('install-description');
                    title.textContent = '‚úÖ App installiert!';
                    description.textContent = 'StreamVault wurde erfolgreich installiert.';
                });
                
                window.pwaHelper.on('criteria', (criteria) => {
                    updateCriteria('criteria-https', criteria.https);
                    updateCriteria('criteria-manifest', criteria.manifest);
                    updateCriteria('criteria-sw', criteria.serviceWorker);
                    updateCriteria('criteria-icons', criteria.icons);
                    updateCriteria('criteria-engagement', criteria.engagement);
                });
                
                // Check criteria immediately
                setTimeout(() => {
                    window.pwaHelper.checkInstallCriteria();
                }, 2000);
            } else {
                // Fallback to original implementation
                checkCriteria();
            }
            
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                        updateCriteria('criteria-sw', true);
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                        updateCriteria('criteria-sw', false);
                    });
            }
            
            // Add user interaction for mobile browsers
            let interactionCount = 0;
            ['click', 'touch', 'scroll'].forEach(event => {
                document.addEventListener(event, () => {
                    interactionCount++;
                    if (interactionCount === 1) {
                        console.log('üëÜ First user interaction detected');
                    }
                }, { once: false });
            });
        });
    </script>
</body>
</html>
